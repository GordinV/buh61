Parameters tnId
Local loXMLHTTP As "MSXML2.XMLHTTP"
Local cUrl, l_tulemus
Local cMessage

IF EMPTY(tnId)
	gRekv = 63
	gUserId = 1713
	cUrl = 'https://finance.omniva.eu/finance/erp/'	
	l_secret = '106549:elbevswsackajyafdoupavfwewuiafbeeiqatgvyqcqdqxairz'
	cMessage = get_test_xml()
	l_fail_id = INT(RAND() * 1000000)
	l_dok_id = 1
	gnHandle = SQLCONNECT('koopia','vlad','Vlad490710')
	
	SET STEP on	
ELSE
	cUrl = Alltrim(v_config_.earved)
	l_secret = ALLTRIM(qryRekv.earved)
	cMessage = get_xml()
	l_fail_id = get_last_file_id()	
	l_dok_id = tnId
ENDIF

* replace <FileId>1</FileId>
cMessage = STUFF(cMessage,ATC('<FileId>1</FileId>',cMessage),LEN('<FileId>1</FileId>'),'<FileId>' + ALLTRIM(STR(l_fail_id))+ '</FileId>')

* replace <?xml version="1.0" encoding="UTF-8"?>
cMessage = STUFF(cMessage,ATC('<?xml version="1.0" encoding="UTF-8"?>',cMessage),LEN('<?xml version="1.0" encoding="UTF-8"?>'),'')

Create Cursor m_memo (url c(120), Header c(120), Request m, response m, Timestamp T Default Datetime())


loXMLHTTP = Createobject("MSXML2.XMLHTTP")

With loXMLHTTP

	.Open("POST", cUrl ,.F.)
	.setRequestHeader('Content-Type', 'text/xml;charset=UTF-8')
	.setRequestHeader('user-agent', 'sampleTest')
	.setRequestHeader('soapAction', '')

	.Send(cMessage)
	
	IF !empty(loXMLHTTP.readystate) 

		Insert Into m_memo (url, Header, Request, response) Values (cUrl, 'text/xml;charset=UTF-8', cMessage, loXMLHTTP.responsetext)
	
	
		IF ATC('Ok', loXMLHTTP.responsetext) > 0
			l_tulemus = .t.
			
			* salvesta file_id
			
			TEXT TO l_sql TEXTMERGE noshow
				INSERT INTO fail_id (fail_id, dok_id, rekvid, kasutaja_id)
					values (<<l_fail_id>>, <<l_dok_id>>, <<gRekv>>,<<gUserId>>)
			ENDTEXT
			l_error = SQLEXEC(gnHandle, l_sql)
			IF l_error < 1
				SET STEP ON 
				l_sql = _cliptext
			ENDIF
				l_sql = _cliptext
			
		ENDIF
	ELSE
		MESSAGEBOX('Server ei vasta',0+64,'e-Arved')
	ENDIF
		

Endwith

IF EMPTY(l_tulemus)
	l_answer = MESSAGEBOX('Tekkis viga, kas näida päring?',4+32+256,'E-arved')
	IF l_answer = 6
		_cliptext = cMessage
		Select m_memo
		MODIFY MEMO m_memo.response 
		RETURN .f.
*		Brow	
	ENDIF
ELSE
	MESSAGEBOX('Arve saadetud!',0+48,'E-arved')
ENDIF

Return .t.
Endfunc

FUNCTION get_last_file_id
	LOCAL l_file_id
	TEXT TO l_sql TEXTMERGE noshow
		SELECT coalesce(MAX(fail_id),0)::integer as file_id FROM fail_id WHERE rekvid = <<gRekv>>
	ENDTEXT
	
	l_error = SQLEXEC(gnHandle, l_sql, 'tmp_file_id')
	
	IF l_error < 1
		SET STEP ON 
		_cliptext = l_sql
		RETURN 0
	ENDIF
	
	IF RECCOUNT('tmp_file_id') = 0 OR EMPTY(tmp_file_id.file_id)
			l_file_id =  1000000
	ELSE
		l_file_id = tmp_file_id.file_id + 1	
	endif

	USE IN tmp_file_id
	
	RETURN l_file_id 
ENDFUNC



FUNCTION get_test_xml
Local l_xml, l_xml_arve

TEXT TO l_xml TEXTMERGE noshow
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:erp="http://e-arvetekeskus.eu/erp">
<soapenv:Header/>
<soapenv:Body>
<erp:EInvoiceRequest authPhrase="106549:elbevswsackajyafdoupavfwewuiafbeeiqatgvyqcqdqxairz">
<E_Invoice>
<Header>
<Date>2019-06-27</Date>
<FileId>1</FileId>
<AppId>EARVE</AppId>
<Version>1.1</Version>
</Header>
<Invoice invoiceId="8123" regNumber="11488826">
<InvoiceParties>
<SellerParty>
<Name>smtp.narva.ee</Name>
<RegNumber>75008427</RegNumber>
<ContactData>
<PhoneNumber>3599190</PhoneNumber>
<LegalAddress>
<PostalAddress1>Peetri 5</PostalAddress1>
<City>Narva</City>
</LegalAddress>
</ContactData>
</SellerParty>
<BuyerParty>
<Name>Danske Bank AS Eesti filiaal AS</Name>
<RegNumber>11488826</RegNumber>
<ContactData>
<E-mailAddress>risto.sylluste@danskebank.ee</E-mailAddress>
<LegalAddress>
<PostalAddress1>Narva mnt 11  Tallinn 10502</PostalAddress1>
<City>Narva mnt 11  Tallinn 10502</City>
</LegalAddress>
</ContactData>
</BuyerParty>
</InvoiceParties>
<InvoiceInformation>
<Type type="DEB"/>
<ContractNumber>test</ContractNumber>
<DocumentName>Arve</DocumentName>
<InvoiceNumber>8113</InvoiceNumber>
<InvoiceContentText>test</InvoiceContentText>
<InvoiceDate>2019-03-01</InvoiceDate>
</InvoiceInformation>
<InvoiceSumGroup>
<InvoiceSum>0.01</InvoiceSum>
<VAT><SumBeforeVAT>0.01</SumBeforeVAT>
<VATRate>20</VATRate>
<VATSum>0.00</VATSum>
<Currency>EUR</Currency>
<SumAfterVAT>0.01</SumAfterVAT></VAT>
<TotalSum>0.01</TotalSum>
<Currency>EUR</Currency>
</InvoiceSumGroup>
<InvoiceItem>
<InvoiceItemGroup>
<ItemEntry>
<Description>Pangaintressid</Description>
<ItemDetailInfo>
<ItemUnit></ItemUnit>
<ItemAmount>1.0000</ItemAmount>
<ItemPrice>0.00</ItemPrice>
</ItemDetailInfo>
<ItemSum>0.01</ItemSum>
<VAT>
<SumBeforeVAT>0.01</SumBeforeVAT>
<VATRate>20</VATRate>
<VATSum>0.00</VATSum>
<Currency>EUR</Currency>
</VAT>
<ItemTotal>0.01</ItemTotal>
</ItemEntry></InvoiceItemGroup>
</InvoiceItem>
<PaymentInfo>
<Currency>EUR</Currency>
<PaymentRefId></PaymentRefId>
<PaymentDescription>Arve 81                  </PaymentDescription>
<Payable>YES</Payable>
<PayDueDate>2019-03-01</PayDueDate> 
<PaymentTotalSum>0.01</PaymentTotalSum>
<PayerName>Danske Bank AS Eesti filiaal AS</PayerName>
<PaymentId>81</PaymentId>
<PayToAccount>EE051010562011276005</PayToAccount>
<PayToName>smtp.narva.ee</PayToName>
</PaymentInfo>
</Invoice>
<Footer>
<TotalNumberInvoices>1</TotalNumberInvoices>
<TotalAmount>0.01</TotalAmount>
</Footer>
</E_Invoice></erp:EInvoiceRequest>
</soapenv:Body>
</soapenv:Envelope>
ENDTEXT
RETURN l_xml
ENDFUNC



Function get_xml
	Local l_xml, l_xml_arve
	
TEXT TO l_xml TEXTMERGE noshow

<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:erp="http://e-arvetekeskus.eu/erp">
<soapenv:Header/>
<soapenv:Body>
<erp:EInvoiceRequest authPhrase="<<l_secret>>">
ENDTEXT
l_xml_arve = calc_earved(tnId)

l_xml = l_xml + l_xml_arve

TEXT TO l_xml TEXTMERGE NOSHOW additive

</erp:EInvoiceRequest>
</soapenv:Body>
</soapenv:Envelope>
ENDTEXT
	Return l_xml
ENDFUNC
